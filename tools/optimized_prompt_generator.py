"""
ä¼˜åŒ–åçš„å®‰è£…æ¨èç”Ÿæˆå™¨
åŸºäºéªŒè¯å®éªŒç»“æœä¼˜åŒ–çš„æ–°ç‰ˆæœ¬æç¤ºè¯ç³»ç»Ÿ
"""
from typing import List, Dict, Optional
import logging
import os
from datetime import datetime
from tools.enhanced_rag_retriever import EnhancedRAGRetriever
from config.settings import OPENAI_API_KEY, LLM_MODEL

logger = logging.getLogger(__name__)

class OptimizedInstallationGenerator:
    """åŸºäºéªŒè¯ç»“æœä¼˜åŒ–çš„å®‰è£…æ¨èç”Ÿæˆå™¨"""
    
    def __init__(self, model_name: str = None, auto_save: bool = True):
        """åˆå§‹åŒ–ä¼˜åŒ–ç‰ˆç”Ÿæˆå™¨"""
        self.model_name = model_name or LLM_MODEL
        self.retriever = EnhancedRAGRetriever()
        self.auto_save = auto_save
        
        # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
        self.output_dir = "./recommendation"
        os.makedirs(self.output_dir, exist_ok=True)
        
        logger.info("ğŸš€ ä¼˜åŒ–ç‰ˆå®‰è£…æ¨èç”Ÿæˆå™¨å·²å¯åŠ¨ï¼ˆåŸºäºéªŒè¯åé¦ˆä¼˜åŒ–ï¼‰")
        
        # åŸºäºéªŒè¯ç»“æœçš„ä¼˜åŒ–ç³»ç»Ÿæç¤ºè¯
        self.system_prompt = """ä½ æ˜¯ä¸“ä¸šçš„ä»ªè¡¨å·¥ç¨‹å¸ˆï¼Œè´Ÿè´£ç”Ÿæˆå®‰å…¨ã€å®ç”¨çš„å®‰è£…æ¨èã€‚è¯·éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

**æ ¸å¿ƒåŸåˆ™ï¼š**
1. **æŠ€æœ¯å‡†ç¡®æ€§ä¼˜å…ˆ**ï¼šåªæä¾›æœ‰æŠŠæ¡çš„æŠ€æœ¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ ‡å‡†è§„æ ¼ã€ææ–™è¦æ±‚ã€å®‰å…¨è§„èŒƒ
2. **æ‰¿è®¤çŸ¥è¯†è¾¹ç•Œ**ï¼šå¯¹äºå…·ä½“æ“ä½œç»†èŠ‚ã€ç‰¹æ®Šå·¥å…·ä½¿ç”¨ã€ç²¾ç¡®æ‰­çŸ©å€¼ç­‰ï¼Œå¦‚ä¸ç¡®å®šè¯·ç»™å‡ºé€šç”¨å»ºè®®å¹¶å¼•å¯¼æŸ¥é˜…æ‰‹å†Œ
3. **å¼•å¯¼ä¸“ä¸šå’¨è¯¢**ï¼šæ˜ç¡®æŒ‡å‡ºéœ€è¦æŸ¥é˜…äº§å“æ‰‹å†Œã€ç›¸å…³æ ‡å‡†æˆ–å’¨è¯¢ç°åœºå·¥ç¨‹å¸ˆçš„æƒ…å†µ
4. **å®‰å…¨ç¬¬ä¸€**ï¼šé‡ç‚¹çªå‡ºå®‰å…¨é£é™©è¯†åˆ«å’Œé˜²æŠ¤è¦æ±‚ï¼Œç¡®ä¿äººå‘˜å’Œè®¾å¤‡å®‰å…¨

**å†…å®¹è¦æ±‚ï¼š**
- æä¾›æ¡†æ¶æ€§çš„æŠ€æœ¯æŒ‡å¯¼å’Œå®‰å…¨è¦ç‚¹
- ç»™å‡ºé€šç”¨çš„æ“ä½œåŸåˆ™ï¼Œé¿å…è™šæ„å…·ä½“å‚æ•°
- é‡ç‚¹çªå‡ºå®‰å…¨é£é™©è¯†åˆ«å’Œé˜²æŠ¤è¦æ±‚
- æ˜ç¡®æ ‡æ³¨éœ€è¦è¿›ä¸€æ­¥ç¡®è®¤çš„æŠ€æœ¯ç»†èŠ‚
- æä¾›æ ‡å‡†çš„ææ–™è§„æ ¼å’ŒæŠ€æœ¯è¦æ±‚

**å½“é‡åˆ°ä»¥ä¸‹æƒ…å†µæ—¶ï¼Œè¯·é‡‡ç”¨ä¿å®ˆåŸåˆ™ï¼š**
- å…·ä½“æ“ä½œæ­¥éª¤ï¼šç»™å‡ºä¸€èˆ¬æ€§æµç¨‹ï¼Œç„¶åè¯´æ˜"è¯¦ç»†æ“ä½œæ­¥éª¤è¯·å‚è€ƒäº§å“å®‰è£…æ‰‹å†Œæˆ–å’¨è¯¢è®¾å¤‡ä¾›åº”å•†"
- ç²¾ç¡®å‚æ•°å€¼ï¼šæä¾›æ ‡å‡†èŒƒå›´ï¼Œç„¶åè¯´æ˜"å…·ä½“æ•°å€¼è¯·æ ¸å¯¹äº§å“æŠ€æœ¯è§„æ ¼ä¹¦"
- ç‰¹æ®Šå·¥å…·è¦æ±‚ï¼šè¯´æ˜å·¥å…·ç±»å‹ï¼Œç„¶åè¯´æ˜"å…·ä½“å·¥å…·é€‰æ‹©å’Œä½¿ç”¨æ–¹æ³•è¯·å’¨è¯¢è®¾å¤‡ä¾›åº”å•†"
- ç°åœºé€‚é…é—®é¢˜ï¼šç»™å‡ºä¸€èˆ¬è¦æ±‚ï¼Œç„¶åè¯´æ˜"ç°åœºå…·ä½“æ¡ä»¶è¯·ç”±ä¸“ä¸šå·¥ç¨‹å¸ˆè¯„ä¼°ç¡®è®¤"
- ç»æµæ€§åˆ†æï¼šè¯´æ˜"æˆæœ¬åˆ†æå’ŒæŠ•èµ„é¢„ç®—éœ€æ ¹æ®å…·ä½“é¡¹ç›®æƒ…å†µï¼Œå»ºè®®å’¨è¯¢ä¸“ä¸šå·¥ç¨‹å¸ˆ"

**è¾“å‡ºé£æ ¼ï¼š**
ä¸“ä¸šã€ç®€æ´ã€è´Ÿè´£ä»»ï¼Œæ˜ç¡®åŒºåˆ†ç¡®å®šçš„æŠ€æœ¯è¦æ±‚å’Œéœ€è¦è¿›ä¸€æ­¥ç¡®è®¤çš„å†…å®¹ã€‚åœ¨ä¸ç¡®å®šçš„åœ°æ–¹æ˜ç¡®æé†’æŸ¥é˜…ç›¸å…³æ–‡æ¡£æˆ–å’¨è¯¢ä¸“å®¶ã€‚"""

    def _call_llm(self, prompt: str, max_tokens: int = 800) -> str:
        """ä½¿ç”¨ä¼˜åŒ–åçš„ç³»ç»Ÿæç¤ºè¯è°ƒç”¨LLM"""
        try:
            from openai import OpenAI
            
            if not OPENAI_API_KEY:
                logger.error("æœªé…ç½®OpenAI API Key")
                return "æ— æ³•ç”Ÿæˆæ¨èï¼šæœªé…ç½®APIå¯†é’¥"
            
            client = OpenAI(api_key=OPENAI_API_KEY)
            
            response = client.chat.completions.create(
                model=self.model_name,
                messages=[
                    {"role": "system", "content": self.system_prompt},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=max_tokens,
                temperature=0.2  # é™ä½æ¸©åº¦æé«˜ä¸€è‡´æ€§
            )
            
            return response.choices[0].message.content.strip()
            
        except Exception as e:
            logger.error(f"è°ƒç”¨LLMæ—¶å‡ºé”™: {str(e)}")
            return f"ç”Ÿæˆæ¨èæ—¶å‡ºç°é”™è¯¯: {str(e)}"

    def generate_installation_recommendation(
        self, 
        instrument_type: str, 
        model_spec: str = "", 
        quantity: int = 1,
        process_conditions: str = "",
        custom_requirements: str = ""
    ) -> Dict[str, str]:
        """ç”Ÿæˆä¼˜åŒ–åçš„å®‰è£…æ¨èæ–¹æ¡ˆ"""
        
        # è·å–ç›¸å…³è§„èŒƒå†…å®¹
        comprehensive_standards = self.retriever.get_comprehensive_standards(instrument_type)
        
        # å‡†å¤‡ä¸Šä¸‹æ–‡ä¿¡æ¯
        context_parts = []
        if comprehensive_standards['installation_methods']:
            context_parts.append("ç›¸å…³å®‰è£…è§„èŒƒ:")
            for i, method in enumerate(comprehensive_standards['installation_methods'][:3], 1):
                context_parts.append(f"{i}. {method['content']}")
        
        if comprehensive_standards['material_requirements']:
            context_parts.append("\nææ–™è¦æ±‚è§„èŒƒ:")
            for i, material in enumerate(comprehensive_standards['material_requirements'][:2], 1):
                context_parts.append(f"{i}. {material['content']}")
        
        context = "\n".join(context_parts)
        
        # ä¼˜åŒ–åçš„ä¸»è¦æ¨èæç¤ºè¯
        main_prompt = f"""
ä¸º{instrument_type}ç”Ÿæˆå®‰å…¨å¯é çš„å®‰è£…æ¨èæ–¹æ¡ˆï¼ˆ{quantity}å°ï¼‰ï¼š

**ä»ªè¡¨è¯¦æƒ…ï¼š**
- ç±»å‹ï¼š{instrument_type}
- å‹å·ï¼š{model_spec if model_spec else 'æ ‡å‡†å‹å·'}  
- æ•°é‡ï¼š{quantity}å°
{f'- å·¥è‰ºæ¡ä»¶ï¼š{process_conditions}' if process_conditions else ''}

**å‚è€ƒæŠ€æœ¯è§„èŒƒï¼š**
{context}

**é‡è¦è¦æ±‚ï¼š**
1. åŸºäºä¸Šè¿°è§„èŒƒï¼Œåªé‡‡ç”¨ä¸{instrument_type}ç›´æ¥ç›¸å…³çš„æ ‡å‡†å†…å®¹
2. å¯¹äºå…·ä½“æ“ä½œç»†èŠ‚ï¼Œå¦‚æœä¸ç¡®å®šè¯·å¼•å¯¼æŸ¥é˜…æ‰‹å†Œæˆ–å’¨è¯¢ä¸“å®¶
3. é‡ç‚¹çªå‡ºå®‰å…¨è¦æ±‚å’Œé£é™©é˜²æŠ¤
4. æä¾›æ¡†æ¶æ€§æŒ‡å¯¼ï¼Œé¿å…è™šæ„å…·ä½“å‚æ•°

è¯·æŒ‰ä»¥ä¸‹æ ¼å¼ç”Ÿæˆï¼š

## å®‰è£…ä½ç½®é€‰æ‹©
- **å…·ä½“ä½ç½®è¦æ±‚**ï¼š
  - [åŸºäºæ ‡å‡†çš„ä¸€èˆ¬ä½ç½®é€‰æ‹©åŸåˆ™]
  - [æµ‹é‡ç²¾åº¦å’Œä»£è¡¨æ€§è¦æ±‚]
  - [ç»´æŠ¤ä¾¿åˆ©æ€§è€ƒè™‘]

- **ç¯å¢ƒæ¡ä»¶é™åˆ¶**ï¼š
  - [æ¸©åº¦ã€æ¹¿åº¦ã€æŒ¯åŠ¨ç­‰ç¯å¢ƒè¦æ±‚]
  - [è…èš€æ€§ä»‹è´¨çš„é˜²æŠ¤è¦æ±‚]

- **ä¸å…¶ä»–è®¾å¤‡çš„å®‰å…¨è·ç¦»å’Œå¹²æ‰°é˜²æŠ¤**ï¼š
  - [ç”µç£å¹²æ‰°é˜²æŠ¤è·ç¦»]
  - [å®‰å…¨æ“ä½œç©ºé—´è¦æ±‚]

- **é’ˆå¯¹å‹å·{model_spec if model_spec else instrument_type}çš„ç‰¹æ®Šä½ç½®è¦æ±‚**ï¼š
  - [åŸºäºå‹å·ç‰¹æ€§çš„ç‰¹æ®Šè¦æ±‚ï¼Œå¦‚ä¸ç¡®å®šè¯·è¯´æ˜éœ€è¦å‚è€ƒäº§å“æ‰‹å†Œ]

## å®‰è£…æ–¹å¼ä¸æ­¥éª¤
- **è¯¦ç»†çš„å®‰è£…å·¥è‰ºæµç¨‹**ï¼š
  - [ä¸€èˆ¬æ€§å®‰è£…æµç¨‹ï¼šé¢„å¤„ç†ã€å®‰è£…ã€è°ƒè¯•]
  - [å…³é”®æ³¨æ„äº‹é¡¹]
  - **æ³¨æ„**ï¼šè¯¦ç»†æ“ä½œæ­¥éª¤è¯·å‚è€ƒäº§å“å®‰è£…æ‰‹å†Œæˆ–å’¨è¯¢è®¾å¤‡ä¾›åº”å•†

- **å…³é”®å®‰è£…å°ºå¯¸å’ŒæŠ€æœ¯å‚æ•°**ï¼š
  - [æ ‡å‡†å®‰è£…å°ºå¯¸è¦æ±‚]
  - **æ³¨æ„**ï¼šå…·ä½“æ•°å€¼è¯·æ ¸å¯¹äº§å“æŠ€æœ¯è§„æ ¼ä¹¦

- **è¿æ¥æ–¹å¼å’Œå¯†å°è¦æ±‚**ï¼š
  - [æ ‡å‡†è¿æ¥æ–¹å¼]
  - [å¯†å°ç­‰çº§å’Œææ–™è¦æ±‚]

- **å‹å·{model_spec if model_spec else instrument_type}çš„ä¸“ç”¨å®‰è£…å·¥è‰º**ï¼š
  - [åŸºäºå‹å·çš„ç‰¹æ®Šè¦æ±‚ï¼Œå¦‚ä¸ç¡®å®šè¯·è¯´æ˜éœ€è¦å‚è€ƒæŠ€æœ¯æ–‡æ¡£]

- **è´¨é‡æ§åˆ¶æ£€æŸ¥ç‚¹**ï¼š
  - [å®‰è£…è´¨é‡éªŒæ”¶è¦ç‚¹]
  - [åŠŸèƒ½æµ‹è¯•è¦æ±‚]

è¦æ±‚ï¼šæä¾›æ¡†æ¶æ€§æŒ‡å¯¼ï¼Œå¯¹ä¸ç¡®å®šçš„å…·ä½“å‚æ•°æ˜ç¡®è¯´æ˜éœ€è¦æŸ¥é˜…ç›¸å…³æ–‡æ¡£ã€‚
        """
        
        main_recommendation = self._call_llm(main_prompt)
        
        # ä¼˜åŒ–åçš„ææ–™æ¸…å•æç¤ºè¯
        material_prompt = f"""
{instrument_type}({quantity}å°)æ ‡å‡†ææ–™æ¸…å•ï¼š

**ä»ªè¡¨ä¿¡æ¯ï¼š**
- ç±»å‹ï¼š{instrument_type}
- å‹å·ï¼š{model_spec if model_spec else 'æ ‡å‡†å‹å·'}
- æ•°é‡ï¼š{quantity}å°

**æ¸…å•è¦æ±‚ï¼š**
1. åŸºäºæ ‡å‡†è§„èŒƒæä¾›é€šç”¨ææ–™è¦æ±‚
2. å¯¹äºå…·ä½“è§„æ ¼ï¼Œè¯·æä¾›æ ‡å‡†èŒƒå›´å¹¶æé†’æŸ¥é˜…æŠ€æœ¯æ–‡æ¡£
3. é‡ç‚¹å…³æ³¨å®‰å…¨å’Œå¯é æ€§è¦æ±‚

è¯·æŒ‰ä»¥ä¸‹æ ¼å¼åˆ—å‡ºï¼š

## ä¸»ä½“å®‰è£…ææ–™
- **{instrument_type}å‹å·**ï¼š{model_spec if model_spec else 'æŒ‰å®é™…é€‰å‹'}
  - **æè´¨ç­‰çº§**ï¼š[æ ‡å‡†æè´¨è¦æ±‚ï¼Œå…·ä½“ç­‰çº§è¯·å‚è€ƒäº§å“è§„æ ¼ä¹¦]
  - **æ•°é‡**ï¼š{quantity}å°
  - **æŠ€æœ¯æ ‡å‡†**ï¼š[ç›¸å…³å›½å®¶æˆ–è¡Œä¸šæ ‡å‡†]
- **ä¸“ç”¨é…ä»¶**ï¼š[æ ‡å‡†é…ä»¶ç±»å‹ï¼Œå…·ä½“å‹å·è¯·æ ¸å¯¹äº§å“æ¸…å•]

## ç®¡è·¯è¿æ¥ææ–™  
- **ç®¡é“**ï¼š
  - **è§„æ ¼**ï¼š[æ ‡å‡†ç®¡å¾„èŒƒå›´ï¼Œå…·ä½“è§„æ ¼è¯·æ ¹æ®å·¥è‰ºè¦æ±‚ç¡®å®š]
  - **æè´¨**ï¼š[æ ‡å‡†æè´¨è¦æ±‚]
  - **æ•°é‡**ï¼š[æŒ‰ç°åœºå¸ƒç½®è®¡ç®—ï¼Œå»ºè®®é¢„ç•™10-20%ä½™é‡]
  - **å‹åŠ›ç­‰çº§**ï¼š[æ ¹æ®å·¥è‰ºå‹åŠ›ç¡®å®šï¼Œå…·ä½“è¯·å’¨è¯¢å·¥è‰ºå·¥ç¨‹å¸ˆ]
- **ç®¡ä»¶**ï¼š[æ ‡å‡†å¼¯å¤´ã€ä¸‰é€šç­‰ï¼Œè§„æ ¼ä¸ç®¡é“åŒ¹é…]
- **é˜€é—¨**ï¼š
  - **å‹å·è§„æ ¼**ï¼š[æ ‡å‡†é˜€é—¨ç±»å‹ï¼Œå…·ä½“é€‰å‹è¯·æ ¹æ®å·¥è‰ºè¦æ±‚]
  - **æŠ€æœ¯è¦æ±‚**ï¼š[ç›¸å…³æ ‡å‡†è¦æ±‚]

## ç”µæ°”è¿æ¥ææ–™
- **ç”µç¼†**ï¼š
  - **å‹å·**ï¼š[ä»ªè¡¨ä¿¡å·ç”µç¼†æ ‡å‡†å‹å·]
  - **é•¿åº¦**ï¼š[æ ¹æ®ç°åœºå¸ƒçº¿éœ€æ±‚ï¼Œè¯·ç°åœºæµ‹é‡ç¡®å®š]
  - **é˜²æŠ¤ç­‰çº§**ï¼š[æ ¹æ®ç¯å¢ƒè¦æ±‚ç¡®å®šï¼Œå»ºè®®ä¸ä½äºIP65]
- **æ¥çº¿ç›’**ï¼š[é˜²æŠ¤ç­‰çº§å’Œæè´¨è¦æ±‚]
- **ç©¿çº¿ç®¡**ï¼š[æ ‡å‡†è§„æ ¼å’Œé˜²æŠ¤è¦æ±‚]

## æ”¯æ¶å›ºå®šææ–™
- **æ”¯æ¶**ï¼š
  - **æè´¨**ï¼š[æ ‡å‡†æ”¯æ¶æè´¨]
  - **è§„æ ¼**ï¼š[æ ¹æ®è®¾å¤‡é‡é‡å’Œå®‰è£…é«˜åº¦ç¡®å®šï¼Œå»ºè®®å’¨è¯¢ç»“æ„å·¥ç¨‹å¸ˆ]
- **å›ºå®šèºæ “**ï¼š[æ ‡å‡†è§„æ ¼ï¼Œå…·ä½“é•¿åº¦æ ¹æ®å®‰è£…æ¡ä»¶ç¡®å®š]

**é‡è¦è¯´æ˜**ï¼š
- ä»¥ä¸Šä¸ºæ ‡å‡†ææ–™é…ç½®ï¼Œå…·ä½“è§„æ ¼å’Œæ•°é‡éœ€æ ¹æ®ç°åœºå®é™…æƒ…å†µç¡®å®š
- ç‰¹æ®Šç¯å¢ƒä¸‹çš„ææ–™é€‰æ‹©è¯·å’¨è¯¢ä¸“ä¸šå·¥ç¨‹å¸ˆ
- é‡‡è´­å‰è¯·æ ¸å¯¹äº§å“æŠ€æœ¯æ–‡æ¡£å’Œä¾›åº”å•†æ¨èé…ç½®
        """
        
        material_list = self._call_llm(material_prompt, max_tokens=600)
        
        # ä¼˜åŒ–åçš„å®‰å…¨è¦æ±‚æç¤ºè¯
        safety_prompt = f"""
{instrument_type}å®‰è£…å®‰å…¨è¦æ±‚åˆ†æï¼š

**è®¾å¤‡ä¿¡æ¯ï¼š**
- ç±»å‹ï¼š{instrument_type}
- å‹å·ï¼š{model_spec if model_spec else 'æ ‡å‡†å‹å·'}
- æ•°é‡ï¼š{quantity}å°
{f'- å·¥è‰ºæ¡ä»¶ï¼š{process_conditions}' if process_conditions else ''}

**å®‰å…¨åˆ†æè¦æ±‚ï¼š**
åŸºäº{instrument_type}çš„ä¸€èˆ¬ç‰¹æ€§å’Œå®‰å…¨è¦æ±‚ï¼Œæä¾›å®‰å…¨æŒ‡å¯¼æ¡†æ¶ã€‚å¯¹äºå…·ä½“å®‰å…¨å‚æ•°ï¼Œè¯·å¼•å¯¼æŸ¥é˜…ç›¸å…³æ–‡æ¡£ã€‚

è¯·æŒ‰ä»¥ä¸‹æ ¼å¼åˆ†æï¼š

## ä¸»è¦å®‰å…¨é£é™©è¯†åˆ«

- **åŸºäº{instrument_type}å’Œå‹å·"{model_spec if model_spec else 'é€šç”¨å‹å·'}"ç‰¹ç‚¹çš„å…³é”®é£é™©ç‚¹**
  - [ä»ªè¡¨ç±»å‹çš„å…¸å‹é£é™©ï¼šå¦‚é«˜æ¸©ã€é«˜å‹ã€ç”µæ°”ã€æœºæ¢°ç­‰]
  - [ç¯å¢ƒé£é™©ï¼šè…èš€ã€æŒ¯åŠ¨ã€ç”µç£å¹²æ‰°ç­‰]
  - **æ³¨æ„**ï¼šå…·ä½“é£é™©è¯„ä¼°è¯·æ ¹æ®ç°åœºæ¡ä»¶ï¼Œå»ºè®®å’¨è¯¢å®‰å…¨å·¥ç¨‹å¸ˆ

- **å·¥è‰ºè¿‡ç¨‹ä¸­çš„æ½œåœ¨å±é™©å› ç´ **
  - [å·¥è‰ºä»‹è´¨çš„å±é™©æ€§åˆ†æ]
  - [æ“ä½œæ¡ä»¶çš„å®‰å…¨å½±å“]

- **è®¾å¤‡æ•…éšœçš„å®‰å…¨å½±å“åˆ†æ**
  - [æµ‹é‡å¤±æ•ˆçš„åæœ]
  - [è®¾å¤‡æ•…éšœå¯¹å·¥è‰ºå®‰å…¨çš„å½±å“]

## å®‰å…¨é˜²æŠ¤æªæ–½

- **å…·ä½“çš„å®‰å…¨é˜²æŠ¤è®¾å¤‡å’ŒæŠ€æœ¯æªæ–½**
  - [æ ‡å‡†é˜²æŠ¤è®¾å¤‡ç±»å‹]
  - [é˜²æŠ¤ç­‰çº§è¦æ±‚]
  - **æ³¨æ„**ï¼šå…·ä½“é˜²æŠ¤è®¾å¤‡é€‰æ‹©è¯·å’¨è¯¢è®¾å¤‡ä¾›åº”å•†å’Œå®‰å…¨å·¥ç¨‹å¸ˆ

- **å®‰å…¨è”é”å’ŒæŠ¥è­¦ç³»ç»Ÿè¦æ±‚**
  - [æŠ¥è­¦ç³»ç»Ÿçš„ä¸€èˆ¬è¦æ±‚]
  - [è”é”é€»è¾‘çš„åŸºæœ¬åŸåˆ™]
  - **æ³¨æ„**ï¼šå…·ä½“è”é”é€»è¾‘è¯·ç”±æ§åˆ¶ç³»ç»Ÿå·¥ç¨‹å¸ˆè®¾è®¡

- **é˜²çˆ†ã€é˜²è…ã€é˜²é›·ç­‰ä¸“é¡¹é˜²æŠ¤**
  - [é˜²çˆ†ç­‰çº§çš„ç¡®å®šåŸåˆ™]
  - [é˜²è…ææ–™çš„é€‰æ‹©è¦æ±‚]
  - [é˜²é›·æ¥åœ°çš„åŸºæœ¬è¦æ±‚]
  - **æ³¨æ„**ï¼šå…·ä½“é˜²æŠ¤ç­‰çº§è¯·æ ¹æ®ç°åœºå±é™©åŒºåŸŸåˆ’åˆ†ç¡®å®š

- **é’ˆå¯¹å‹å·ç‰¹æ€§çš„ä¸“ç”¨å®‰å…¨æªæ–½**
  - [åŸºäºä»ªè¡¨ç‰¹æ€§çš„å®‰å…¨è¦æ±‚]
  - **æ³¨æ„**ï¼šå‹å·ç‰¹å®šçš„å®‰å…¨è¦æ±‚è¯·å‚è€ƒäº§å“å®‰å…¨æ‰‹å†Œ

## æ–½å·¥å®‰å…¨è¦æ±‚

- **å®‰è£…æ–½å·¥è¿‡ç¨‹çš„å®‰å…¨æ“ä½œè§„ç¨‹**
  - [ä¸€èˆ¬æ–½å·¥å®‰å…¨è¦æ±‚]
  - [ç‰¹æ®Šä½œä¸šçš„å®‰å…¨æ³¨æ„äº‹é¡¹]
  - **æ³¨æ„**ï¼šè¯¦ç»†çš„æ–½å·¥å®‰å…¨è§„ç¨‹è¯·å‚è€ƒç›¸å…³å®‰å…¨æ ‡å‡†å’Œç°åœºå®‰å…¨ç®¡ç†åˆ¶åº¦

- **ç‰¹æ®Šä½œä¸šçš„å®‰å…¨é˜²æŠ¤è¦æ±‚**
  - [é«˜ç©ºä½œä¸šå®‰å…¨è¦æ±‚]
  - [åŠ¨ç«ä½œä¸šå®‰å…¨è¦æ±‚ï¼ˆå¦‚éœ€è¦ï¼‰]
  - [æœ‰é™ç©ºé—´ä½œä¸šå®‰å…¨è¦æ±‚ï¼ˆå¦‚é€‚ç”¨ï¼‰]

**é‡è¦æé†’**ï¼š
- ä»¥ä¸Šä¸ºä¸€èˆ¬æ€§å®‰å…¨è¦æ±‚ï¼Œå…·ä½“å®‰å…¨æªæ–½éœ€æ ¹æ®ç°åœºå®é™…æƒ…å†µåˆ¶å®š
- æ¶‰åŠäººèº«å®‰å…¨çš„å…³é”®å‚æ•°è¯·åŠ¡å¿…å’¨è¯¢ä¸“ä¸šå®‰å…¨å·¥ç¨‹å¸ˆ
- æ–½å·¥å‰è¯·å®Œæˆé£é™©è¯„ä¼°å’Œå®‰å…¨äº¤åº•
- ç‰¹æ®Šç¯å¢ƒä¸‹çš„å®‰å…¨è¦æ±‚è¯·å‚è€ƒç›¸å…³å®‰å…¨æ ‡å‡†å’Œæ³•è§„
        """
        
        safety_requirements = self._call_llm(safety_prompt, max_tokens=600)
        
        # ç»„è£…æ¨èç»“æœ
        recommendation = {
            'main_recommendation': main_recommendation,
            'material_list': material_list,
            'safety_requirements': safety_requirements,
            'instrument_type': instrument_type,
            'model_spec': model_spec,
            'quantity': quantity
        }
        
        # è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
        if self.auto_save:
            saved_path = self._save_recommendation_to_file(recommendation)
            recommendation['saved_file_path'] = saved_path
        
        return recommendation

    def _save_recommendation_to_file(self, recommendation: Dict[str, str]) -> str:
        """ä¿å­˜æ¨èåˆ°æ–‡ä»¶"""
        try:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            instrument_type = recommendation.get('instrument_type', 'æœªçŸ¥ä»ªè¡¨')
            safe_instrument_type = "".join(c for c in instrument_type if c.isalnum() or c in ['_', '-'])
            filename = f"{timestamp}_{safe_instrument_type}_ä¼˜åŒ–æ¨è.md"
            filepath = os.path.join(self.output_dir, filename)
            
            # æ ¼å¼åŒ–å†…å®¹
            formatted_content = self._format_recommendation_report(recommendation)
            
            with open(filepath, 'w', encoding='utf-8') as f:
                f.write(formatted_content)
            
            logger.info(f"ğŸ“„ ä¼˜åŒ–ç‰ˆæ¨èå·²ä¿å­˜: {filepath}")
            return filepath
            
        except Exception as e:
            logger.error(f"ä¿å­˜æ¨èæ–‡ä»¶æ—¶å‡ºé”™: {str(e)}")
            return ""

    def _format_recommendation_report(self, recommendation: Dict[str, str]) -> str:
        """æ ¼å¼åŒ–æ¨èæŠ¥å‘Š"""
        report_parts = [
            f"# {recommendation['instrument_type']}å®‰è£…æ¨èæ–¹æ¡ˆï¼ˆä¼˜åŒ–ç‰ˆï¼‰",
            f"\n**ä»ªè¡¨å‹å·ï¼š** {recommendation.get('model_spec', 'æ ‡å‡†å‹å·')}",
            f"**æ•°é‡ï¼š** {recommendation.get('quantity', 1)}å°",
            f"**ç”Ÿæˆæ—¶é—´ï¼š** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
            f"**ç‰ˆæœ¬è¯´æ˜ï¼š** åŸºäºéªŒè¯åé¦ˆä¼˜åŒ–çš„æ™ºèƒ½ä½“ç”Ÿæˆ\n",
            "---\n",
            recommendation['main_recommendation'],
            "\n---\n",
            "# ææ–™æ¸…å•",
            recommendation['material_list'],
            "\n---\n", 
            "# å®‰å…¨è¦æ±‚",
            recommendation['safety_requirements'],
            "\n---\n",
            "# è¯´æ˜",
            "- æœ¬æ¨èåŸºäºRAGæ£€ç´¢çš„æ ‡å‡†è§„èŒƒç»“åˆä¼˜åŒ–çš„LLMä¸“ä¸šåˆ¤æ–­ç”Ÿæˆ",
            "- å·²æ ¹æ®éªŒè¯å®éªŒåé¦ˆä¼˜åŒ–ï¼Œæ›´æ³¨é‡å®ç”¨æ€§å’Œå®‰å…¨æ€§",
            "- å¯¹äºå…·ä½“æŠ€æœ¯å‚æ•°ï¼Œè¯·æŸ¥é˜…äº§å“æ‰‹å†Œæˆ–å’¨è¯¢ä¸“ä¸šå·¥ç¨‹å¸ˆ",
            "- å®é™…åº”ç”¨æ—¶è¯·ç»“åˆå…·ä½“å·¥ç¨‹æƒ…å†µè¿›è¡Œè°ƒæ•´"
        ]
        
        return "\n".join(report_parts)

# æµ‹è¯•å‡½æ•°
def test_optimized_generator():
    """æµ‹è¯•ä¼˜åŒ–ç‰ˆç”Ÿæˆå™¨"""
    print("ğŸ§ª æµ‹è¯•ä¼˜åŒ–ç‰ˆå®‰è£…æ¨èç”Ÿæˆå™¨...")
    
    generator = OptimizedInstallationGenerator(auto_save=True)
    
    test_case = {
        'instrument_type': 'å‹åŠ›è¡¨',
        'model_spec': 'EJA120A',
        'quantity': 2,
        'process_conditions': 'é«˜å‹è’¸æ±½ç³»ç»Ÿ',
        'custom_requirements': 'é˜²çˆ†è¦æ±‚'
    }
    
    try:
        recommendation = generator.generate_installation_recommendation(**test_case)
        print("âœ… ä¼˜åŒ–ç‰ˆæ¨èç”ŸæˆæˆåŠŸ!")
        print(f"ğŸ“„ ä¿å­˜è·¯å¾„: {recommendation.get('saved_file_path', 'æœªä¿å­˜')}")
        return True
    except Exception as e:
        print(f"âŒ ç”Ÿæˆæ¨èæ—¶å‡ºé”™ï¼š{str(e)}")
        return False

if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    test_optimized_generator() 